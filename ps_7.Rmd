---
title: "ps_7"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
library(tidyverse)
library(stringr)
library(fs)
library(scales)
library(lubridate)
library(dplyr)
library(knitr)
library(tibble)
library(foreign)
library(kableExtra)
library(formattable)
library(readxl)
library(readr)
library(janitor)
library(tibble)
library(purrr)
library(ggplot2)

# *****may want to create a variable that's like dem_adv - dem_win to adhere to prompt*****

download.file(url = "https://goo.gl/ZRCBda",
              destfile = "upshot.zip", 
              quiet = TRUE,
              mode = "wb")

unzip("upshot.zip") 

file_names <- dir_ls("2018-live-poll-results-master/data/")
polling_data <- map_dfr(file_names, read_csv, .id = "source")


dem_win <- read_excel("rmd_data/mt_2_ps.xlsx") %>% 
  clean_names() %>% 
  select(x_1, dem_votes, rep_votes, other_votes, type) %>% 
  rename(district = x_1) %>% 
  mutate(district = tolower(district)) %>% 
  mutate(dem_win = (dem_votes)/(rep_votes+dem_votes+other_votes)) %>% 
  select(district, dem_win, type) %>% 
  filter(type != "Senate") %>% 
  filter(type != "Governor") %>% 
  filter(!is.na(dem_win))

dem_polling <- polling_data %>% 
  select(source, response, final_weight) %>% 
  mutate(state = str_sub(source, 51, 52)) %>%
  mutate(wave = str_extract(source, pattern = "[\\d].csv$")) %>% 
  mutate(wave = parse_integer(str_sub(wave, 1, 1))) %>% 
  mutate(office = case_when(str_detect(source, pattern = "sen") ~ "SEN",
                            str_detect(source, pattern = "gov") ~ "GOV",
                            TRUE ~ "HSE")) %>% 
  filter(office != "SEN") %>% 
  filter(office != "GOV") %>% 
  mutate(district = str_extract(source, pattern = "[\\d]{2}-[\\d].csv$")) %>% 
  mutate(district = str_sub(district, 1, 2)) %>% 
  mutate(District = paste(state, district, sep = "")) %>%  
  select(District, response, final_weight, wave) %>% 
  filter(wave %in% c("2","3")) %>% 
  rename(district = District) %>% 
  filter(district != "pa01") %>% 
  filter(!(response %in% c("3","4","5","6"))) %>% 
  group_by(district, response) %>% 
  tally(wt = final_weight) %>% 
  spread(key = response, value = n) %>% 
  mutate(dem_margin = Dem / (Dem+Rep+Und)) %>% 
  select(district, dem_margin)


  

prediction_data <- polling_data %>% 
  mutate(source = str_replace(source, "2018-live-poll-results-master/data/elections-poll-","\\")) %>% 
  mutate(source = str_replace(source, ".csv","\\")) %>% 
  separate(source, c("role","wave"), "-") %>% 
  select(role, wave, race_eth, educ4, final_weight) %>% 
  filter(race_eth != "[DO NOT READ] Don't know/Refused") %>% 
  filter(educ4 != "[DO NOT READ] Don't know/Refused") %>% 
  mutate(educ4 = case_when(educ4 == "Postgraduate Degree" ~ "Postgrad",
                           educ4 == "4-year College Grad." ~ "College grad",
                           educ4 == "Some College Educ." ~ "Some College",
                           educ4 == "High School Grad. or Less" ~ "HS")) %>% 
  mutate(race_educ5 = paste(race_eth, educ4, sep = ", ")) %>% 
  rename(district = role)
  
full_data <- prediction_data %>%   
  left_join(dem_win, by = "district") %>% 
  filter(!is.na(type)) 
  # is this calculation necessary or correct?
 

black_voters <- full_data %>% 
  filter(race_eth == "Black") %>% 
  group_by(district, race_educ5) %>% 
  tally(wt = final_weight) %>% 
  spread(key = race_educ5, value = n) %>% 
  # NOT CERTAIN WHAT THE VALUES HERE ACTUALLY ARE
  clean_names() %>% 
  mutate(total = black_college_grad + black_hs + black_postgrad + black_some_college) %>% 
  filter(!is.na(total)) %>% 
  mutate(black_college_grad = (black_college_grad / total)*100) %>% 
  mutate(black_hs = (black_hs / total)*100) %>% 
  mutate(black_postgrad = (black_postgrad / total)*100) %>% 
  mutate(black_some_college = (black_some_college / total)*100) %>% 
  left_join(dem_win, by = "district") %>% 
  left_join(dem_polling, by = "district") %>% 
  filter(!is.na(dem_win)) %>% 
  filter(!is.na(dem_margin)) %>% 
  mutate(dem_error = dem_win - dem_margin) 
  


black_voters %>% 
  ggplot(aes(x = black_hs, y = dem_win)) + geom_jitter()

write_rds(black_voters, "ps_7_app/black_voters.rds")

hisp_voters <- full_data %>% 
  filter(race_eth == "Hispanic") %>% 
  group_by(district, race_educ5) %>% 
  tally(wt = final_weight) %>% 
  spread(key = race_educ5, value = n) %>% 
  clean_names() %>% 
  left_join(dem_win, by = "district") %>% 
  filter(!is.na(type)) 

#hisp_voters <- na.omit(hisp_voters)

hisp_voters %>% 
  ggplot(aes(x = hispanic_hs, y = dem_win)) + geom_jitter()

hisp_voters

asian_voters <- full_data %>% 
  filter(race_eth == "Asian") %>% 
  group_by(district, race_educ5) %>% 
  tally(wt = final_weight) %>% 
  spread(key = race_educ5, value = n) %>% 
  clean_names() %>% 
  left_join(dem_win, by = "district") %>% 
  filter(!is.na(type)) 

asian_voters <- na.omit(asian_voters)

white_voters <- full_data %>% 
  filter(race_eth == "White") %>% 
  group_by(district, race_educ5) %>% 
  tally(wt = final_weight) %>% 
  spread(key = race_educ5, value = n) %>% 
  clean_names() %>% 
  left_join(dem_win, by = "district") %>% 
  filter(!is.na(type)) 

white_voters <- na.omit(white_voters)

other_voters <- full_data %>% 
  filter(race_eth == "Other") %>% 
  group_by(district, race_educ5) %>% 
  tally(wt = final_weight) %>% 
  spread(key = race_educ5, value = n) %>% 
  clean_names() %>% 
  left_join(dem_win, by = "district") %>% 
  filter(!is.na(type)) 

other_voters <- na.omit(other_voters)

all_voters <- black_voters %>% 
  left_join(white_voters, by = "district") %>% 
  left_join(hisp_voters, by = "district") %>% 
  left_join(asian_voters, by = "district") %>% 
  left_join(other_voters, by = "district") 

all_voters <- na.omit(all_voters)


write_rds(all_voters, "ps_7_app/all_voters.rds")



```

